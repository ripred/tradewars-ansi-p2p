#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
SESSION="${1:-twansi-4p}"

BASE_PORT="${BASE_PORT:-40100}"
SHARD="${SHARD:-alpha}"

homes=("$ROOT/.demo1" "$ROOT/.demo2" "$ROOT/.demo3" "$ROOT/.demo4")
rm -rf "${homes[@]}"
mkdir -p "${homes[@]}"

seed1="127.0.0.1:$((BASE_PORT+1))"
seed2="127.0.0.1:$((BASE_PORT+0))"
seed3="127.0.0.1:$((BASE_PORT+0))"
seed4="127.0.0.1:$((BASE_PORT+0))"

PYTHONPATH="$ROOT/src" TWANSI_HOME="${homes[0]}" python3 -m twansi.main init --nick p1 --listen "127.0.0.1:$((BASE_PORT+0))" --shard "$SHARD" --seed "$seed1" >/dev/null
PYTHONPATH="$ROOT/src" TWANSI_HOME="${homes[1]}" python3 -m twansi.main init --nick p2 --listen "127.0.0.1:$((BASE_PORT+1))" --shard "$SHARD" --seed "$seed2" >/dev/null
PYTHONPATH="$ROOT/src" TWANSI_HOME="${homes[2]}" python3 -m twansi.main init --nick p3 --listen "127.0.0.1:$((BASE_PORT+2))" --shard "$SHARD" --seed "$seed3" >/dev/null
PYTHONPATH="$ROOT/src" TWANSI_HOME="${homes[3]}" python3 -m twansi.main init --nick p4 --listen "127.0.0.1:$((BASE_PORT+3))" --shard "$SHARD" --seed "$seed4" >/dev/null

tmux kill-session -t "$SESSION" 2>/dev/null || true
tmux new-session -d -s "$SESSION" -n game "cd '$ROOT' && PYTHONPATH='$ROOT/src' TWANSI_HOME='${homes[0]}' python3 -m twansi.main run"
tmux split-window -h -t "$SESSION":game "cd '$ROOT' && PYTHONPATH='$ROOT/src' TWANSI_HOME='${homes[1]}' python3 -m twansi.main run"
tmux split-window -v -t "$SESSION":game.0 "cd '$ROOT' && PYTHONPATH='$ROOT/src' TWANSI_HOME='${homes[2]}' python3 -m twansi.main run"
tmux split-window -v -t "$SESSION":game.1 "cd '$ROOT' && PYTHONPATH='$ROOT/src' TWANSI_HOME='${homes[3]}' python3 -m twansi.main run"
tmux select-layout -t "$SESSION":game tiled

tmux new-window -t "$SESSION" -n bots
tmux split-window -v -t "$SESSION":bots
tmux split-window -v -t "$SESSION":bots
tmux split-window -v -t "$SESSION":bots
tmux select-layout -t "$SESSION":bots even-vertical

tmux send-keys -t "$SESSION":bots.0 "cd '$ROOT' && twansi bot --host 127.0.0.1 --port $((BASE_PORT+0+100)) --seconds 999999 --aggressiveness 0.25" C-m
tmux send-keys -t "$SESSION":bots.1 "cd '$ROOT' && twansi bot --host 127.0.0.1 --port $((BASE_PORT+1+100)) --seconds 999999 --aggressiveness 0.25" C-m
tmux send-keys -t "$SESSION":bots.2 "cd '$ROOT' && twansi bot --host 127.0.0.1 --port $((BASE_PORT+2+100)) --seconds 999999 --aggressiveness 0.25" C-m
tmux send-keys -t "$SESSION":bots.3 "cd '$ROOT' && twansi bot --host 127.0.0.1 --port $((BASE_PORT+3+100)) --seconds 999999 --aggressiveness 0.25" C-m
tmux select-layout -t "$SESSION":bots even-vertical

echo "tmux session started: $SESSION"
echo "attach: tmux attach -t $SESSION"
